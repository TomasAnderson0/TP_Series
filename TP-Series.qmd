---
format: pdf
editor: visual
lang: "es"
header-includes:
  - \usepackage{ragged2e}
  - \usepackage{hyperref}
---

\Centering

\vspace{3cm}

\pagenumbering{gobble}

\vspace{5cm}

\large

LICENCIATURA EN ESTADÍSTICA

\vspace{1cm}

\large
\Huge

"Series" \Huge \newline \vspace{0.3cm}

\normalsize

Trabajo Práctico 3 \vspace{1cm}

Autores: Tomás Anderson

Docentes:

05/06/2024 \normalsize

```{=tex}
\newpage
\hypersetup{linkcolor = black}
\tableofcontents
```
```{=tex}
\newpage
\pagenumbering{arabic}
```
```{=tex}
\RaggedRight
\newpage
```

## Introducción

Argentina se destaca como uno de los principales exportadores de productos agrícolas a nivel mundial, lo que convierte al sector agrícola en un pilar esencial de su economía. Este sector no solo contribuye significativamente al Producto Interno Bruto (PIB), sino que también genera un gran número de empleos, haciendo que su prosperidad sea fundamental para el desarrollo del país.

Una métrica clave para cuantificar la actividad económica de este sector es el Valor Agregado Bruto (VAB). Esta magnitud económica mide el valor añadido generado por los productores en un área específica, reflejando el valor que se agrega a los bienes y servicios en las diversas etapas del proceso productivo. En términos sencillos, el VAB se calcula restando el total de costos de producción del valor del producto final, proporcionando una visión clara de la contribución económica real del sector.

Este estudio se centrará en el análisis del VAB trimestral del sector de agricultura, ganadería, caza y silvicultura desde 2004 hasta la actualidad. El objetivo es modelar la evolución de esta métrica a lo largo del tiempo, lo que permitirá predecir el estado futuro del sector agrícola y su potencial desarrollo.

## Análisis descriptivo

Como primer medida se grafica el VAB a traves del tiempo para observar la estructura que presenta los datos.

```{r, warning=FALSE, echo=FALSE, message = FALSE, fig.cap = "Serie del VAB. Periodo 2004-2024"}
library(ggplot2)
library(dplyr)
library(readr)
library(plotly)
library(gridExtra)
library(lubridate)
library(tsibble)
library(feasts)
library(forecast)
library(fpp3)
library(car)
library(zoo)
datos_total =read_csv("producto-interno-bruto-valores-trimestrales-base-2004.csv")[,1:2] 
colnames(datos_total) = c("indice_tiempo", "agricultura")
datos <-datos_total[1:78,]
options(scipen = 999)


ggplot(data = datos) + 
  aes(x = indice_tiempo, y = agricultura) +
  geom_line(color = "steelblue", size = .78) + 
  labs(x = "Años", y = "Millones de pesos (a precios de 2004)") + 
  scale_x_date(limits = c(as.Date("2004-01-01"),as.Date("2024-04-01")),
               breaks = seq(from = as.Date("2004-01-01"),
                            to = as.Date("2024-04-01"), by = "2 years"),
               date_labels = "%Y") + geom_point(color = "#D34343", size = 1)


```

En la figura 1 se puede observar que el Valor Agregado Bruto (VAB) trimestral no presenta un comportamiento estacionario en términos de media, ya que muestra un incremento continuo a lo largo del tiempo. Es importante destacar que los segundos trimestres de cada año son los períodos en los que se registran los mayores ingresos en los sectores de agricultura, ganadería, caza y silvicultura. Además, la variabilidad del VAB no parece estar relacionada con el paso del tiempo.

```{r, warning=FALSE, echo=FALSE, message = FALSE, fig.cap="Comportamiento anual del VAB"}
datos_t <- datos %>% mutate(indice_tiempo = yearquarter(indice_tiempo)) %>% as_tsibble(index = indice_tiempo)

gg_season(datos_t, agricultura, labels = "both") + labs(x = "Años", y = "VAB") + theme_bw()


```

En la figura 2 se puede apreciar un comportamiento estacional en el VAB, donde los primeros, terceros y cuartos trimestres presentan patrones bastante similares. En contraste, el segundo trimestre destaca por un VAB significativamente superior al del resto del año, tendencia que se repite cada año. Esto indica que el período más favorable para la agricultura se concentra entre abril y junio.






```{r, warning=FALSE, echo=FALSE, message = FALSE, fig.cap="Comportamiento del"}

gg_subseries(datos_t, agricultura) + labs(x = "Trimestres", y = "VAB") + theme_bw()



```

Como en la anterior, en la figura 3 se observa claramente la diferencia en el VAB medio entre los trimestres. Además, se puede apreciar de manera más evidente la falta de estacionaridad, ya que el VAB parece mostrar un aumento constante a lo largo de los años.



```{r, warning=FALSE, echo=FALSE, message = FALSE, fig.cap = "Autocorrelación y autocorrelación parcial muestral", fig.height=6}
bacf <- acf(datos$agricultura, plot = FALSE, lag.max = 70)

bacfdf <- with(bacf, data.frame(lag, acf))

ciline <- qnorm((1 - .95)/2)/sqrt(length(datos$agricultura))

auto1 = ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
       geom_hline(aes(yintercept = 0)) +
       geom_segment(mapping = aes(xend = lag, yend = 0), color = "salmon") + 
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') +
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') +
  scale_y_continuous(breaks = seq(-.4,1,.2)) +
  scale_x_continuous(breaks = seq(0,80,10)) +
  labs(y = "Autocorrelación", x = "Rezagos", title = "FACM")


bacf <- pacf(datos$agricultura, plot = FALSE, lag.max = 70)

bacfdf <- with(bacf, data.frame(lag, acf))

auto2 = ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
       geom_hline(aes(yintercept = 0)) +
       geom_segment(mapping = aes(xend = lag, yend = 0), color = "salmon") + 
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') +
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') +
  scale_y_continuous(breaks = seq(-1,1,.2)) +
  scale_x_continuous(breaks = seq(0,80,10)) +
  labs(y = "Autocorrelación", x = "Rezagos", title = "FACPM")

grid.arrange(auto1, auto2, nrow = 2)

```
En la figura 4 se evidencia la necesidad de realizar una diferenciación estacional, ya que los valores de los rezagos múltiplos de 4 de la Función de Autocorrelación Muestral (FACM) muestran un decrecimiento lineal. Esto sugiere que, al ajustar un modelo autoregresivo en la parte estacional, la estimación del parámetro estará próxima a 1.

Se aplica una diferenciación estacional, lo que resulta en la siguiente serie:

```{r, warning=FALSE, echo=FALSE, message = FALSE, eval=FALSE}
tsData = ts(datos$agricultura, start = c(2004,1), frequency = 4)
auto.arima(y = tsData)
```

```{r, warning=FALSE, echo=FALSE, message = FALSE}
datos = datos %>%  mutate(agricultura_dif_4 = difference(agricultura, 4))

ggplot(data = datos) + 
  aes(x = indice_tiempo, y = agricultura_dif_4) +
  geom_line(color = "steelblue", size = .78) + 
  labs(x = "Años", y = "Millones de pesos (a precios de 2004)") + 
  scale_x_date(limits = c(as.Date("2004-01-01"),as.Date("2024-04-01")),
               breaks = seq(from = as.Date("2004-01-01"),
                            to = as.Date("2024-04-01"), by = "2 years"),
               date_labels = "%Y") + 
  geom_point(color = "#D34343", size = 1)

# datos_t_4 <- datos[,c(1,3)] %>% mutate(indice_tiempo = yearquarter(indice_tiempo)) %>% as_tsibble(index = indice_tiempo)
# 
# 
# 
# datos_t_4 %>% 
#   gg_season(agricultura_dif_4, labels = "both") + labs(x = "Años", y = "VAB") + theme_bw()
# datos_t_4 %>% 
# gg_subseries(agricultura_dif_4) + labs(x = "Trimestres", y = "VAB") + theme_bw()



```

Al aplicar la diferencia, la nueva serie de tiempo resulta estacionaria en media. 



```{r, warning=FALSE, echo=FALSE, message = FALSE, fig.height=6}
bacf <- acf(datos$agricultura_dif_4[-c(1,2,3,4)], plot = FALSE, lag.max = 70)
bacfdf <- with(bacf, data.frame(lag, acf))
ciline <- qnorm((1 - .95)/2)/sqrt(length(datos$agricultura_dif_4[-c(1,2,3,4)]))

auto3 = ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
       geom_hline(aes(yintercept = 0)) +
       geom_segment(mapping = aes(xend = lag, yend = 0), color = "salmon") + 
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') +
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') +
  scale_y_continuous(breaks = seq(-.4,1,.2)) +
  scale_x_continuous(breaks = seq(0,80,10)) +
  labs(y = "Autocorrelacion", x = "Rezagos")



bacf <- pacf(datos$agricultura_dif_4[-c(1,2,3,4)], plot = FALSE, lag.max = 70)
bacfdf <- with(bacf, data.frame(lag, acf))

auto4 = ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
       geom_hline(aes(yintercept = 0)) +
       geom_segment(mapping = aes(xend = lag, yend = 0), color = "salmon") + 
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') +
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') +
  scale_y_continuous(breaks = seq(-.4,1,.2)) +
  scale_x_continuous(breaks = seq(0,80,10)) +
  labs(y = "Autocorrelacion", x = "Rezagos")

grid.arrange(auto3, auto4, nrow = 2)

```

Según la estructura de autocorrelación y autocorrelación parcial muestral presentada en la figura X, se concluye que la componente estacional puede modelarse con un MA(1), dado que se observa un decrecimiento exponencial de los rezagos estacionales en la FACPM, y solo el rezago 4 resulta significativo en la FACM. En cuanto a la componente regular, no se identifican valores significativos, por lo que se modelará como ruido blanco. Así, el modelo propuesto es un SARIMA(0,0,0)(0,1,1)$_4$.

## Analisis de residuos

```{r, echo = FALSE, warning=FALSE}
modelo = datos_t %>% model(arima = ARIMA(agricultura ~ pdq(0,0,0) + PDQ(0,1,1)))

datos_modelos = augment(modelo) %>% mutate(res = .innov/sd(.innov))

datos_modelos %>%
  
  ggplot() + 
  aes(y = res, x = as.Date(indice_tiempo)) +
  geom_line(color = "steelblue", size = .78) +
  geom_point(color = "#D34343", size = 1) +
  labs(y = "Residuos estandarizados", x = "Años") + 
  scale_y_continuous(limits = c(-5,5), breaks = seq(-5,5,1)) +
  geom_hline(yintercept = mean(augment(modelo)$.innov/sd(augment(modelo)$.innov)), color = "black", linetype = "dashed") +
  scale_x_date(date_breaks = "2 year",
               date_labels = "%Y", 
               limits = c(as.Date("2003-01-01"), as.Date("2023-04-01"))) +
  geom_text(aes(y = .5, x = as.Date("2003-01-01") ,label = "Media"))



```

Se puede observar que la media de los residuos es aproximadamente igual a 0, y que visualmente pareceria corroborarse que la variancia sea constante a traves del tiempo. Hay dos observaciones que tiene residuos que se encuentran por fuera del intervalo $[-3,3]$, que dan un indicio de ser observaciones atipicas.


```{r, warning=FALSE, echo=FALSE, message = FALSE, fig.height=6}



bacf <- acf(datos_modelos$res, plot = FALSE, lag.max = 70)
bacfdf <- with(bacf, data.frame(lag, acf))
ciline <- qnorm((1 - .95)/2)/sqrt(length(datos_modelos$res))

auto3 = ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
       geom_hline(aes(yintercept = 0)) +
       geom_segment(mapping = aes(xend = lag, yend = 0), color = "salmon") + 
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') +
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') +
  scale_y_continuous(breaks = seq(-.4,1,.2)) +
  scale_x_continuous(breaks = seq(0,80,10)) +
  labs(y = "Autocorrelacion", x = "Rezagos")



bacf <- pacf(datos_modelos$res, plot = FALSE, lag.max = 70)
bacfdf <- with(bacf, data.frame(lag, acf))

auto4 = ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
       geom_hline(aes(yintercept = 0)) +
       geom_segment(mapping = aes(xend = lag, yend = 0), color = "salmon") + 
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') +
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') +
  scale_y_continuous(breaks = seq(-.4,1,.2)) +
  scale_x_continuous(breaks = seq(0,80,10)) +
  labs(y = "Autocorrelacion", x = "Rezagos")

grid.arrange(auto3, auto4, nrow = 2)

```
Visualmente, solo dos rezagos en la funcion de autocorrelacion parcial muestral de los residuos caen por poco fuera de las bandas de significacion, por lo tanto, para estar seguros de que los residuos sean ruidos blancos se prueba con el test de ljung-box.

```{r, echo = FALSE}
num = numeric(20)
for (i in 1:20) {
  num[i] = augment(modelo) |>
  features(.innov, ljung_box, lag = 4*i) %>% select(lb_pvalue) %>% as.numeric()
}

num

```
Introducir tabla.

No se rechaza ningun test por lo que se cumple el supuesto de incorrelacion.



```{r, echo = FALSE}
  
  # report(modelo)
shap = datos_modelos$res %>% 
        shapiro.test()

ggplot(datos_modelos) + 
  aes(sample = res) + 
  stat_qq() +
  stat_qq_line() +
  labs(x = "Cuantiles normales", y = "Residuos estandarizados") +
  geom_text(aes(y = -3, x = 2, label = "Shapiro-Test")) +
  geom_text(aes(y = -3.4, x = 2, label = "p-value: <0.00001"))


```


La normalidad no se cumple. El p-value del test de Shapiro-wilks es <0.0001.

```{r}
report(modelo)
```


Como el modelo planteado tiene un unico parametro, este sera el modelo mas parsimonioso posible.


```{r}
prediccion = modelo %>% forecast(h = 4)

mean(abs((datos_total[79:82,2] - prediccion$.mean)/datos_total[79:82,2])[,1])*100
```
```{r}
datos_final <- datos_total %>% mutate(indice_tiempo = yearquarter(indice_tiempo)) %>% as_tsibble(index = indice_tiempo)

modelo_final = datos_final %>% model(arima = ARIMA(agricultura ~ pdq(0,0,0) + PDQ(0,1,1)))



modelo_final %>% forecast(h = 4) %>% autoplot(datos_final)

```






